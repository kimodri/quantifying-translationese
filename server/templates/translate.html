{% extends "layout.html" %}

{% block title %}Translate{% endblock %}

{% block content %}
<div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Translating Documents...</div>
    <div class="loading-subtext">This process may take some time depending on file size.</div>
</div>
<div class="translate-main-container">
    <div class="upload-wrapper">
        
        <h1 class="page-title">Translate Documents</h1>

        <form id="translate-form" action="/translate" method="POST" enctype="multipart/form-data" class="upload-box">
            
            <div class="settings-area">
                
                <div class="setting-group">
                    <label for="local-path" class="white-label">Local Output Path (Required):</label>
                    <input type="text" id="local-path" name="local_path" class="styled-input" placeholder="e.g., C:/datasets/translated_output/" required>
                    <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-top: 5px;">Folder where translated files will be saved.</p>
                </div>

                <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.3); margin: 20px 0;">

                <div class="setting-group">
                    <label for="model-select" class="white-label">Select Translation Model:</label>
                    <select id="model-select" name="model" class="styled-input">
                        <option value="opus" selected>Helsinki-NLP Opus</option>
                        <option value="google">Google Translate</option>
                        <option value="azure">Azure Translate</option>
                        <option value="deepl">DeepL Translate</option>
                    </select>
                </div>

                <div id="simple-api-group" class="setting-group" style="display: none;">
                    <label for="api-key-input" class="white-label">Enter API Key:</label>
                    <input type="password" id="api-key-input" name="api_key" class="styled-input" placeholder="Paste your API key here...">
                </div>

                <div id="azure-group" class="setting-group" style="display: none;">
                    <div style="margin-bottom: 10px;">
                        <label for="azure-key" class="white-label">Azure Key:</label>
                        <input type="password" id="azure-key" name="azure_key" class="styled-input" placeholder="Paste Azure Key...">
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label for="azure-region" class="white-label">Azure Region:</label>
                        <input type="text" id="azure-region" name="azure_region" class="styled-input" placeholder="e.g., eastus">
                    </div>
                    <div>
                        <label for="azure-endpoint" class="white-label">Azure Endpoint:</label>
                        <input type="text" id="azure-endpoint" name="azure_endpoint" class="styled-input" placeholder="e.g., https://api.cognitive.microsofttranslator.com">
                    </div>
                </div>

            </div>

            <div class="upload-dashed-area">
                
                <input type="file" id="file-upload" name="file" multiple hidden>

                <label for="file-upload" class="upload-label">
                    <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="12" y1="18" x2="12" y2="12"></line>
                        <line x1="9" y1="15" x2="12" y2="12"></line>
                        <line x1="15" y1="15" x2="12" y2="12"></line>
                    </svg>

                    <div class="choose-btn">
                        <span>CHOOSE FILES</span>
                        <span class="arrow">▼</span>
                    </div>
                    
                    <p class="drop-text">or drop files here</p>
                </label>

                <div id="file-list-display" style="margin-top: 15px; color: white; text-align: center;"></div>

                <button type="submit" id="translate-btn" class="quantify-submit-btn" style="display: none;">
                    Translate
                </button>

            </div>
        </form>
    </div>
</div>
<script>
    // --- 1. DOM ELEMENTS ---
    const fileInput = document.getElementById('file-upload');
    const fileListDisplay = document.getElementById('file-list-display');
    const translateBtn = document.getElementById('translate-btn');
    const translateForm = document.getElementById('translate-form');
    const loadingOverlay = document.getElementById('loading-overlay');
    const dropText = document.querySelector('.drop-text');
    
    // Elements for Settings Logic
    const modelSelect = document.getElementById('model-select');
    
    // Simple API Group (Google/DeepL)
    const simpleApiGroup = document.getElementById('simple-api-group');
    const simpleApiKeyInput = document.getElementById('api-key-input');

    // Azure Group
    const azureGroup = document.getElementById('azure-group');
    const azureKeyInput = document.getElementById('azure-key');
    const azureRegionInput = document.getElementById('azure-region');
    const azureEndpointInput = document.getElementById('azure-endpoint');


    // --- 2. MODEL SELECTION LOGIC ---
    modelSelect.addEventListener('change', function() {
        const selectedModel = this.value;
        
        // Reset Everything First
        simpleApiGroup.style.display = 'none';
        simpleApiKeyInput.required = false;
        
        azureGroup.style.display = 'none';
        azureKeyInput.required = false;
        azureRegionInput.required = false;
        azureEndpointInput.required = false;

        // Apply Logic based on selection
        if (selectedModel === 'google' || selectedModel === 'deepl') {
            // Show Simple API Key
            simpleApiGroup.style.display = 'block';
            simpleApiKeyInput.required = true;
        } 
        else if (selectedModel === 'azure') {
            // Show Azure Fields
            azureGroup.style.display = 'block';
            azureKeyInput.required = true;
            azureRegionInput.required = true;
            azureEndpointInput.required = true;
        }
        // 'opus' does nothing (stays hidden)
    });


    // --- 3. FILE UPLOAD LOGIC ---
    const dataTransfer = new DataTransfer();

    fileInput.addEventListener('change', function() {
        const newFiles = Array.from(this.files);
        newFiles.forEach(file => {
            const fileExists = Array.from(dataTransfer.files).some(existing => 
                existing.name === file.name && existing.size === file.size
            );
            if (!fileExists) dataTransfer.items.add(file);
        });
        fileInput.files = dataTransfer.files;
        renderFileList();
    });

    function renderFileList() {
        if (dataTransfer.files.length > 0) {
            fileListDisplay.innerHTML = '<p><strong>Selected Files:</strong></p>';
            const list = document.createElement('ul');
            list.style.listStyle = 'none';
            list.style.padding = '0';

            Array.from(dataTransfer.files).forEach((file, index) => {
                const item = document.createElement('li');
                item.style.marginBottom = '8px';
                item.style.display = 'flex';
                item.style.alignItems = 'center';
                item.style.justifyContent = 'center';
                item.style.gap = '10px';

                const textSpan = document.createElement('span');
                textSpan.textContent = `${file.name}`;
                
                const removeBtn = document.createElement('span');
                removeBtn.textContent = '❌';
                removeBtn.style.cursor = 'pointer';
                removeBtn.style.fontSize = '0.8rem';
                removeBtn.onclick = function() { removeFile(index); };

                item.appendChild(textSpan);
                item.appendChild(removeBtn);
                list.appendChild(item);
            });
            
            fileListDisplay.appendChild(list);
            translateBtn.style.display = 'inline-block';
            if(dropText) dropText.style.display = 'none'; 
        } else {
            fileListDisplay.innerHTML = '';
            translateBtn.style.display = 'none';
            if(dropText) dropText.style.display = 'block';
        }
    }

    function removeFile(indexToRemove) {
        const newDataTransfer = new DataTransfer();
        Array.from(dataTransfer.files).forEach((file, index) => {
            if (index !== indexToRemove) newDataTransfer.items.add(file);
        });
        dataTransfer.items.clear();
        Array.from(newDataTransfer.files).forEach(file => dataTransfer.items.add(file));
        fileInput.files = dataTransfer.files;
        renderFileList();
    }

    // --- 4. SUBMIT EVENT ---
    translateForm.addEventListener('submit', function(event) {
        if (dataTransfer.files.length > 0) {
            loadingOverlay.style.display = 'flex';
        }
    });

</script>
{% endblock %}s